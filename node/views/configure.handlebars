<form method="get" action="{{return_to}}" id="configform">
<fieldset>
<legend>Units</legend>
<p>Show distance in meters/kilometers or yards/miles?</p>
<label class="long"><input type="radio" name="units" value="metric" id="metric" checked="checked" /> Metric (m, km)</label>
<label class="long"><input type="radio" name="units" value="imperial" id="imperial" /> Imperial (y, mi)</label>
</fieldset>
<fieldset>
<legend>Update interval</legend>
<p>How often location should be checked? (More often consumes more battery.)</p>
<select name="interval">
<option value="0">Automatic</option>
<option value="1">Once a second</option>
<option value="2">Every 2 seconds</option>
<option value="5">Every 5 seconds</option>
<option value="10">Every 10 seconds</option>
<option value="30">Every 30 seconds</option>
<option value="60">Once a minute</option>
</select>
</fieldset>
<fieldset>
<legend>Compass sensitivity</legend>
<p>How fast the app should react to changes in compass heading?</p>
<label class="short"><input type="radio" name="sens" value="1" id="fast" /> Fast</label>
<label class="short"><input type="radio" name="sens" value="5" id="normal" checked="checked" /> Normal</label>
<label class="short"><input type="radio" name="sens" value="10" id="slow" /> Slow</label>
</fieldset>
<input type="submit" value="Save configuration" />
</form>
<div id="tok"></div>
<script type="text/javascript">
 var f = document.forms[0];
 var tokenDiv = document.getElementById('tok');
 f.onsubmit = sendConfig;
 var conf;
 var token = '{{token}}';
 var json = getQueryParam('conf');
 if (json && (json.charAt(0) == '{')) {
   conf = JSON.parse(json);
  }
  else {
   console.log('Invalid config ' + json);
  }
  if (conf) {
   if (conf.units == 'imperial') {
    document.getElementById('imperial').checked = true;
   }
   for (var i=0; i<f.interval.options.length; i++) {
    var opt = f.interval.options[i];
    if (opt.value == conf.interval) {
     opt.selected = true;
    }
   }
   if (conf.sens < 4) {
    document.getElementById('fast').checked = true;
   }
   else if (conf.sens > 6) {
    document.getElementById('slow').checked = true;
   }
 }
 if (token) {
     var text = document.createTextNode('Your Pebble Timeline token is ');
     var tt = document.createElement('tt');
     tt.appendChild(document.createTextNode(token));
     var p = document.createElement('p');
     p.appendChild(text);
     p.appendChild(tt);
     tokenDiv.appendChild(p);
     a = document.createElement('a');
     a.href = 'mailto:?subject=PebbleTimelineToken&body=' + token;
     a.appendChild(document.createTextNode('Send by mail'));
     p = document.createElement('p');
     p.appendChild(a);
     p.appendChild(document.createTextNode(' (or just save as draft from which you can copy and paste)'));
     tokenDiv.appendChild(p);
     tokenDiv.style.display = 'block';
 }
 function sendConfig(e) {
  e.preventDefault();
  var config = {
    units: f.units.value,
    interval: f.interval.value,
    sens: f.sens.value
  };
  // console.log(config);
  location.href = '{{return_to}}' + encodeURIComponent(JSON.stringify(config));
  return false;
 }
 function getQueryParam(variable) {
  var query = location.search.substring(1);
  var vars = query.split('&');
  for (var i=vars.length-1; i>=0; i--) {
   var pair = vars[i].split('=');
   if (pair[0] == variable) {
    return decodeURIComponent(pair[1]);
   }
  }
  return false;
 }
</script>
